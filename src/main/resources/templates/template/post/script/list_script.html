<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script th:fragment="postList" th:inline="javascript">
    const categoryTitle = [[${categoryTitle}]];
    const siDo = [[${siDo}]];
    const siGunGu = [[${siGunGu}]];
    const eupMyeonDong = [[${eupMyeonDong}]];

    const pageSize = 6;
    let start = 0;
    let last = start + pageSize;

    $(document).ready(function () {
        postCategories();

        $(window).scroll(function () {
            if ($(window).scrollTop() >= $(document).height() - $(window).height()) {
                start += pageSize;
                last += pageSize;
                postCategories();
            }
        })

        $("#siDoSel").val(siDo).prop("selected", true);
        $("#siGunGuSel").val(siGunGu).prop("selected", true);
        $("#eupMyeonDongSel").val(eupMyeonDong).prop("selected", true);

        $("#siDoSel").change(function () {
            const selectedSido = $("#siDoSel option:selected").val();

            window.location.href = '/posts/' + categoryTitle + '/' + selectedSido;
        });

        $("#siGunGuSel").change(function () {
            const selectedSigungu = $("#siGunGuSel option:selected").val();

            window.location.href = '/posts/' + categoryTitle + '/' + siDo + '/' + selectedSigungu;
        });

        $("#eupMyeonDongSel").change(function () {
            const selectedEupmyeondong = $("#eupMyeonDongSel option:selected").val();

            window.location.href = '/posts/' + categoryTitle + '/' + siDo + '/' + siGunGu + '/' + selectedEupmyeondong;
        });


    });

    const postCategories = function () {
        const uri = window.location.protocol + "//" + window.location.host + "/api" + window.location.pathname;
        console.log(uri);
        $.ajax({
            url: uri,
            type: "post",
            dataType: "json",
            contentType: "application/json;  charset=UTF-8",
            success: function (posts) {
                if (posts.length == 0) {
                    $("#content").append("<div>\n" +
                        "                <h2 class=\"text-center text-info mt-5\">해당 컨텐츠가 없습니다.</h2>\n" +
                        "            </div>");
                } else {
                    for (let i = start; i < last; i++) {
                        if (i == posts.length + 1) return;
                        $("#content").append("            <div class=\"col-md-6 h-25\">\n" +
                            "                <div class=\"row g-0 border rounded mb-4 shadow-sm post\">\n" +
                            "                    <div class=\"col p-4 d-flex flex-column\">\n" +
                            "                        <a href='/post/" + posts[i].id + '\'' + "class=\"text-decoration-none\">\n" +
                            "                            <div class=\"row justify-content-between\">\n" +
                            "                                <h3 class=\"mb-1 fs-3 fw-bold col-md-auto text-truncate\">" + posts[i].title + "</h3>\n" +
                            "                            </div>\n" +
                            "                        </a>\n" +
                            "                        <p class=\"mb-3 text-secondary\">" + posts[i].siDo + ' ' + posts[i].siGunGu + ' ' + posts[i].eupMyeonDong + "</p>\n" +
                            "                        <div class=\"mb-4 text-truncate col-md-auto content\">" + posts[i].content + "</div>\n" +
                            "                        <div class=\"row post-info\">\n" +
                            "                            <div class=\"mb-1 col-md\">" + posts[i].nickname + "</div>\n" +
                            "                        </div>\n" +
                            "                        <div class=\"row post-info\">\n" +
                            "                            <div class=\"mb-1 col-md-3 text-muted\">조회수</div>\n" +
                            "                            <div class=\"mb-1 text-muted col-md-6 text-end\">" + posts[i].regdate + "</div>\n" +
                            "                        </div>\n" +
                            "                    </div>\n" +
                            "                </div>\n" +
                            "            </div>\n");
                    }
                }
            }
        });
    }
</script>
</body>
</html>